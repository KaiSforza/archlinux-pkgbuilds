# Original Maintainer: Jaroslav Lichtblau <dragonlord@aur.archlinux.org>
# Maintainer: Alexander "butterbrot" Hausmann <alexander-hausmann@web.de>
# Contributor: Jakob "flocke" Nixdorf <flocke@user-helfen-usern.de>

pkgname=0ad-svn
pkgver=12972
pkgrel=1
pkgdesc="Cross-platform, 3D and historically-based real-time strategy game"
arch=('i686' 'x86_64')
url="http://wildfiregames.com/0ad"
license=('GPL2' 'CCPL')
depends=('binutils' 'boost' 'crypto++' 'devil' 'enet>=1.3.0' 'gamin' 'libogg' 'libpng' 'libvorbis' 'libxml2' 'mesa' 'nasm>2.06' 'openal' 'sdl' 'wxgtk' 'zlib')
makedepends=('subversion' 'gcc>=4.3' 'cmake' 'zip')
#options=('!makeflags')
md5sums=('SKIP'
         '0ca5f80c1fb0f0f4c42365580c8c61d8')

source=("0ad::svn+http://svn.wildfiregames.com/public/ps/trunk"
        'boost-mt-fix.patch')
_svnmod="0ad"

pkgver(){
    cd ${srcdir}/${_svnmod}
}

build() {
msg "Creating start script..."
    create_start_script

msg "Applying boost-mt fix..."
  cd ${srcdir}/${_svnmod}/build/premake
  patch -uN extern_libs4.lua < ${srcdir}/boost-mt-fix.patch

msg "Updating Workspaces..."
  cd ${srcdir}/${_svnmod}/build/workspaces
  ./update-workspaces.sh #--with-system-enet

msg "Building 0AD..."
  cd ${srcdir}/${_svnmod}/build/workspaces/gcc
  make
}

package(){
msg "Installing binaries..."
  install -d ${pkgdir}/opt/0ad
  cp -r ${srcdir}/$_svnmod/binaries/* ${pkgdir}/opt/0ad

msg "Removing SVN stuff..."
  cd ${pkgdir}/opt/0ad
  find -name ".svn" -type d -print0 | xargs -0 rm -rf

msg "Removing sucky windows stuff..."
  cd ${pkgdir}/opt/0ad/system
  rm {*.exe,*.dll,*.bat,Microsoft.VC*,*.sys,*.pdb}
  rm -rf {ape,textureconv}

msg "Fixing file permissions..."
  cd ${pkgdir}/opt/0ad/data
  chown -R root:games ${pkgdir}/opt/0ad

msg "Installing run script..."
  install -D -m755 ${srcdir}/$pkgname.sh ${pkgdir}/usr/bin/$pkgname
}

create_start_script(){
cat >> "${srcdir}/${pkgname}.sh"  << __EOF__
#!/bin/sh
cd /opt/0ad/system
./pyrogenesis $*
__EOF__
}
